{"state":{"content":"<h1>Servers and exporting</h1>\n<p>There are two ways to run a Perseus app: you can <em>serve</em> it, or you can <em>export</em> it. To understand the difference, we'll need to dive a little deeper into how Perseus builds your app.</p>\n<h2>1. Preparation</h2>\n<p>In the first stage, Perseus compiles both itself and your project, and then takes a look at your <code>PerseusApp</code>. This tells it what to expect in terms of internationalization, templates, and capsules, and allows it to formulate a plan to move ahead with.</p>\n<h2>2. Building</h2>\n<p>Now, Perseus calls the build-time logic on every single template in your app, building as many as it possibly can. Those with capsules that would stall this process are rescheduled if that's permitted. Once this stage is done, Perseus compiles the <em>render configuration</em>, which defines all the templates in your app, and then terminates.</p>\n<h2>3. Wasm building</h2>\n<p><em>(White lie: this actually happens in parallel with steps 1 and 2.)</em></p>\n<p>Next, Perseus will compile itself and your app to Wasm. Once this is done, there's no further processing performed on the Wasm bundle unless we're in release mode (in which case it's optimized to the nth degree).</p>\n<h2>4a. Serving</h2>\n<p>From here, if you've chosen to serve your app, Perseus will take the engine it used to build your app and repurpose that for serving your app (one binary does both, reducing compilation times substantially). This will spin up a server according to your <code>#[perseus::main(..)]</code> settings, and that will run until you terminate it, serving your app where you've specified.</p>\n<p>This server responds to each request by passing it through special pathways that are capable of calling request-time logic, state amalgamation, revalidation, and all manner of other things. This part of Perseus involves <em>just-in-time nested capsule resolution</em>, which is by far the most complex part of Perseus. All this has to be done upon receiving a user's request, so this binary is deliberately optimized for speed (meaning it can easily blow out to very large sizes) in release mode.</p>\n<h3>Server integrations</h3>\n<p>Since Perseus tries to be as open as possible, it allows you to provide a custom function to <code>#[perseus::main(..)]</code> that will run your server. Usually, you'll just use the default server provided by one of the integrations, but you can also customize this however you like..</p>\n<p>Server integrations are special crates, like <code>perseus-axum</code>, that provide the boilerplate to host Perseus through a particular server framework. Currently, Perseus has server integrations for <a href=\"https://github.com/actix/actix-web\">Actix Web</a>, <a href=\"https://github.com/seanmonstar/warp\">Warp</a> (although Warp itself appears to be unmaintained), and <a href=\"https://github.com/tokio-rs/axum\">Axum</a>. All of these have a <code>dflt-server</code> feature flag, which you can enable to gain access to the <code>perseus-&lt;integration-name&gt;::dflt_server</code> function, which will spin up a server that just hosts Perseus.</p>\n<p>However, most apps also have several API routes associated with them, especially if you're working with a database. Since you can provide a custom function to host Perseus, you can also add arbitrary API routes. You can take a look at the <a href=\"https://github.com/framesurge/perseus/tree/main/examples/core/custom_server\">custom server example</a> for further details on this, or take a look at the source code for the server integration you're using.</p>\n<p><em>Note: due to <a href=\"https://github.com/seanmonstar/warp/issues/171\">this bug</a>, the Warp integration must currently be used with the <a href=\"https://crates.io/crates/warp-fix-171\"><code>warp-fix-171</code></a> crate, rather than the <code>warp</code> crate itself. As Warp itself appears to no longer be maintained, this situation is unlikely to change any time soon.</em></p>\n<h4>Writing a server integration</h4>\n<p>If you're unhappy with the defaults a particular server integration provides, you are <em>strongly</em> encouraged to modify it yourself, which isn't a difficult process at all. Deliberately, Perseus abstracts nearly all serving functionality into the core, behind a type called <code>Turbine</code>, a static reference to which is provided to server integrations. This means all you're doing in a server integration is spinning up the right routes. In fact, all server integrations follow a pre-defined pattern of exactly what they have to do, making it much easier to write and modify them for your needs. If you really want, you can even fly solo without a server integration, and implement everything yourself (although this is not recommended unless you have very specific requirements).</p>\n<p>Currently, Perseus has no support for arbitrary middleware, and modifying the server integration is the only way to do this. Bear in mind, however, that the Axum integration is only one file with 173 lines of code and comments in it --- these integrations are designed to be tweaked!</p>\n<h2>4b. Exporting</h2>\n<p>Alternately, if you've chosen to export, Perseus will mimic what the server does a little. It will first rearrange all the files the build process generated into folders that mimic the structure of the requests the client will send (e.g. things in <code>dist/static</code> get moved to <code>dist/exported/.perseus/static</code>), and then it will loop through all the pages and create initial load files for all of them. If you were serving your app, Perseus would insert page fragments into your <em>index view</em> at request-time, but exported apps do this ahead-of-time so no processing is required at request-time.</p>\n<p>The output of exporting is a folder (<code>dist/exported</code>) that contains everything needed to run your app. Importantly, exported apps don't have access to any request-time features, like incremental generation or revalidation, and using any of these will cause the build process to neatly fail. However, exported apps are often a lot easier to deploy. For example, deploying this website is just a matter of uploading the generated static files to the <code>gh-pages</code> branch, and GitHub oes the rest for us (because there's no server involved, it's much easier to orchestrate these kinds of deployments). Exported apps are also usually cheaper to host.</p>\n<p>When you run <code>perseus deploy -e</code>, Perseus will build your Wasm in release mode and move everything into a <code>pkg/</code> folder that's fully optimized for production.</p>\n<p><em>Note: <code>perseus export -s</code> exists to spin up a miniature file server to avoid your needing to bring your own in development.</em></p>\n<h3>Error pages in exported apps</h3>\n<p>One thing exported apps often struggle with is proper error handling. Once the Wasm bundle has been delivered to the client, they're fine and dandy, and can display all the errors they like, but the server-side is trickier. When Perseus controls it, it can carefully format error pages with exactly the right information, but typical file servers aren't quite so subtle. Especially for internationalized apps, this can be a problem. The best solution is to export your error pages to static files, which can be done like so:</p>\n<pre><code class=\"language-sh\">perseus export-error-page --code 404 --output pkg/404.html\n</code></pre>\n<p>Here, we export the 404 page to <code>pkg/404.html</code>, where it will be picked up and served in the event of a 404 error by most file hosts. However, since we don't know the user's locale in advance, we can't localize this page appropriately, or even send the right translations. For apps not using i18n, this won't be a problem, but i18n-ed apps should prefer serving over exporting where possible.</p>\n<p>Note that adding <code>-s</code> to a <code>perseus export</code> command in development will automatically export your 404 page, but the deployment system will not do this, so you may wish to make this a separate stage in your deployment process, depending on whether your file host supports this pattern.</p>\n","current_version":"next","manifest":{"0.1.x":{"docs_rs":"0.1","git":"v0.1.4","state":"outdated"},"0.2.x":{"docs_rs":"0.2","git":"v0.2.3","state":"outdated"},"0.3.0-0.3.3":{"docs_rs":"0.3.3","git":"v0.3.3","state":"outdated"},"0.3.4":{"docs_rs":"0.3","git":"v0.3.6","state":"outdated"},"0.4.x":{"docs_rs":"0.4","git":"HEAD","state":"stable"}},"sidebar_content":"<h1>Introduction</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/intro\">Introduction</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/quickstart\">Quickstart</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/what-is-perseus\">What is Perseus?</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/core-principles\">Core Principles</a></li>\n</ul>\n<h1>Your First App</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/first-app/installation\">Installing Perseus</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/first-app/defining\">Defining your app</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/first-app/generating-pages\">Generating pages</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/first-app/dev-cycle\">Development cycle</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/first-app/error-handling\">Error handling</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/first-app/deploying\">Deploying your app</a></li>\n</ul>\n<h1>Fundamentals</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/perseus-app\"><code>PerseusApp</code></a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/reactor\">The reactor</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/routing\">Routing and navigation</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/preloading\">Preloading</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/i18n\">Internationalization</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/error-views\">Error views</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/hydration\">Hydration</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/static-content\">Static content</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/head-headers\">Heads and headers</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/styling\">Styling</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/js-interop\">Working with JS</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/serving-exporting\">Servers and exporting</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/debugging\">Debugging</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/testing\">Writing tests</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/plugins\">Plugins</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/fundamentals/compilation-times\">Improving Compilation Times</a></li>\n</ul>\n<h1>The State Platform</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/intro\">Understanding state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/build\">Build-time state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/request\">Request-time state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/revalidation\">Revalidation</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/incremental\">Incremental generation</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/amalgamation\">State amalgamation</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/browser\">Using state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/global\">Global state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/helper\">Helper state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/suspense\">Suspended state</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/freezing-thawing\">Freezing and thawing</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/state/manual\">Manually implementing <code>ReactiveState</code></a></li>\n</ul>\n<h1>Capsules</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/capsules/intro\">Introduction</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/capsules/using\">Using capsules</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/capsules/capsules-vs-components\">Capsules vs. components</a></li>\n</ul>\n<h1>Miscellaneous</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/migrating\">Migrating from v0.3.x</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/next/faq\">Common pitfalls and FAQs</a></li>\n</ul>\n","status":"Next","title":"Servers and exporting"},"head":"<title>Servers and exporting | Perseus Docs</title><link rel=stylesheet href=.perseus/static/styles/markdown.css><link rel=stylesheet href=.perseus/static/styles/docs_links_markdown.css><link rel=stylesheet href=.perseus/static/prism.css>"}