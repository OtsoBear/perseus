{"state":{"content":"<h1>Docker Deployment</h1>\n<p>For situations where <a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/deploying/serverful\">serverful deployment</a> is required, or in case there is a need to deploy one of the examples found on GitHub without prior setup of all necessary dependencies, below are <code>Dockerfile</code> examples meant to serve for different deployment scenarios. These steps can also serve as guidelines for production deployments.</p>\n<p>Note that the following examples should be modified for your particular use-case rather than being used as-is. Also, these <code>Dockerfile</code>s are standalone because they use <code>curl</code> to download examples directly from the Perseus repository (of course, you'll probably want to use your own code in production).</p>\n<p>Before proceeding with this section, you should be familiar with Docker's <a href=\"https://docs.docker.com/develop/develop-images/multistage-build\">multi-stage builds system</a> and Perseus' <a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/deploying/size\">code size optimizations</a>.</p>\n<details>\n<summary>Production example using the size optimizations plugin</summary>\n<pre><code class=\"language-dockerfile\"># get the base image\nFROM rust:1.57-slim AS build\n\n# install build dependencies\nRUN apt update \\\n  &amp;&amp; apt install -y --no-install-recommends lsb-release apt-transport-https \\\n  build-essential curl wget\n\n# vars\nENV PERSEUS_VERSION=0.3.3 \\\n  PERSEUS_SIZE_OPT_VERSION=0.1.7 \\\n  ESBUILD_VERSION=0.14.7 \\\n  BINARYEN_VERSION=104\n\n# prepare root project dir\nWORKDIR /app\n\n# download the target for wasm\nRUN rustup target add wasm32-unknown-unknown\n\n# install wasm-pack\nRUN cargo install wasm-pack\n\n# retrieve the src dir\nRUN curl https://codeload.github.com/framesurge/perseus-size-opt/tar.gz/main | tar -xz --strip=2 perseus-size-opt-main/examples/simple\n\n# go to src dir\nWORKDIR /app/simple\n\n# install perseus-cli\nRUN cargo install perseus-cli --version $PERSEUS_VERSION\n\n# clean and prep app\nRUN perseus clean &amp;&amp; perseus prep\n\n# specify deps in app config\nRUN sed -i s&quot;/perseus = .*/perseus = \\&quot;${PERSEUS_VERSION}\\&quot;/&quot; ./Cargo.toml \\\n  &amp;&amp; sed -i s&quot;/perseus-size-opt = .*/perseus-size-opt = \\&quot;${PERSEUS_SIZE_OPT_VERSION}\\&quot;/&quot; ./Cargo.toml \\\n  &amp;&amp; cat ./Cargo.toml\n\n# modify lib.rs\nRUN sed -i s'/SizeOpts::default()/SizeOpts { wee_alloc: true, lto: true, opt_level: &quot;s&quot;.to_string(), codegen_units: 1, enable_fluent_bundle_patch: false, }/' ./src/lib.rs \\\n  &amp;&amp; cat ./src/lib.rs\n\n# run plugin(s) to adjust app\nRUN perseus tinker \\\n  &amp;&amp; cat .perseus/Cargo.toml \\\n  &amp;&amp; cat ./src/lib.rs\n\n# single-threaded perseus CLI mode required for low memory environments\n#ENV PERSEUS_CLI_SEQUENTIAL=true\n\n# deploy app\nRUN perseus deploy\n\n# go back to app dir\nWORKDIR /app\n\n# download and unpack esbuild\nRUN curl -O https://registry.npmjs.org/esbuild-linux-64/-/esbuild-linux-64-${ESBUILD_VERSION}.tgz \\\n  &amp;&amp; tar xf esbuild-linux-64-${ESBUILD_VERSION}.tgz \\\n  &amp;&amp; ./package/bin/esbuild --version\n\n# run esbuild against bundle.js\nRUN ./package/bin/esbuild ./simple/pkg/dist/pkg/perseus_engine.js --minify --target=es6 --outfile=./simple/pkg/dist/pkg/perseus_engine.js --allow-overwrite \\\n  &amp;&amp; ls -lha ./simple/pkg/dist/pkg\n\n# download and unpack binaryen\nRUN wget -nv https://github.com/WebAssembly/binaryen/releases/download/version_${BINARYEN_VERSION}/binaryen-version_${BINARYEN_VERSION}-x86_64-linux.tar.gz \\\n  &amp;&amp; tar xf binaryen-version_${BINARYEN_VERSION}-x86_64-linux.tar.gz \\\n  &amp;&amp; ./binaryen-version_${BINARYEN_VERSION}/bin/wasm-opt --version\n\n# run wasm-opt against bundle.wasm\nRUN ./binaryen-version_${BINARYEN_VERSION}/bin/wasm-opt -Os ./simple/pkg/dist/pkg/perseus_engine_bg.wasm -o ./simple/pkg/dist/pkg/perseus_engine_bg.wasm \\\n  &amp;&amp; ls -lha ./simple/pkg/dist/pkg\n\n# prepare deployment image\nFROM debian:stable-slim\n\nWORKDIR /app\n\nCOPY --from=build /app/simple/pkg /app/\n\nENV HOST=0.0.0.0\n\nCMD [&quot;./server&quot;]\n</code></pre>\n</details>\n<details>\n<summary>Production examples using `wee_alloc` manually</summary>\n<pre><code class=\"language-dockerfile\"># get the base image\nFROM rust:1.57-slim AS build\n\n# install build dependencies\nRUN apt update \\\n  &amp;&amp; apt install -y --no-install-recommends lsb-release apt-transport-https \\\n  build-essential curl wget\n\n# vars\nENV PERSEUS_VERSION=0.3.5 \\\n  WEE_ALLOC_VERSION=0.4 \\\n  ESBUILD_VERSION=0.14.7 \\\n  BINARYEN_VERSION=104\n\n# prepare root project dir\nWORKDIR /app\n\n# download the target for wasm\nRUN rustup target add wasm32-unknown-unknown\n\n# install wasm-pack\nRUN cargo install wasm-pack\n\n# retrieve the src dir\nRUN curl https://codeload.github.com/framesurge/perseus/tar.gz/v${PERSEUS_VERSION} | tar -xz --strip=2 perseus-${PERSEUS_VERSION}/examples/tiny\n\n# go to src dir\nWORKDIR /app/tiny\n\n# install perseus-cli\nRUN cargo install perseus-cli --version $PERSEUS_VERSION\n\n# specify deps in app config\nRUN sed -i s&quot;/perseus = .*/perseus = \\&quot;${PERSEUS_VERSION}\\&quot;/&quot; ./Cargo.toml \\\n  &amp;&amp; sed -i &quot;/\\[dependencies\\]/a wee_alloc = \\&quot;${WEE_ALLOC_VERSION}\\&quot;&quot; ./Cargo.toml \\\n  &amp;&amp; cat ./Cargo.toml\n\n# modify and prepend lib.rs\nRUN echo '#[global_allocator] \\n\\\nstatic ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT; \\n\\\n' | cat - ./src/lib.rs &gt; ./src/lib.rs.tmp \\\n  &amp;&amp; mv ./src/lib.rs.tmp ./src/lib.rs \\\n  &amp;&amp; cat ./src/lib.rs\n\n# clean, prep and eject app\nRUN perseus clean &amp;&amp; perseus prep &amp;&amp; perseus eject\n\n# adjust and append perseus config\nRUN sed -i s&quot;/perseus = .*/perseus = \\&quot;${PERSEUS_VERSION}\\&quot;/&quot; .perseus/Cargo.toml \\\n  &amp;&amp; echo ' \\n\\n\\\n[profile.release] \\n\\\ncodegen-units = 1 \\n\\\nopt-level = &quot;s&quot; \\n\\\nlto = true ' &gt;&gt; .perseus/Cargo.toml \\\n  &amp;&amp; cat .perseus/Cargo.toml\n\n# single-threaded perseus CLI mode required for low memory environments\n#ENV PERSEUS_CLI_SEQUENTIAL=true\n\n# deploy app\nRUN perseus deploy\n\n# go back to app dir\nWORKDIR /app\n\n# download and unpack esbuild\nRUN curl -O https://registry.npmjs.org/esbuild-linux-64/-/esbuild-linux-64-${ESBUILD_VERSION}.tgz \\\n  &amp;&amp; tar xf esbuild-linux-64-${ESBUILD_VERSION}.tgz \\\n  &amp;&amp; ./package/bin/esbuild --version\n\n# run esbuild against bundle.js\nRUN ./package/bin/esbuild ./tiny/pkg/dist/pkg/perseus_engine.js --minify --target=es6 --outfile=./tiny/pkg/dist/pkg/perseus_engine.js --allow-overwrite \\\n  &amp;&amp; ls -lha ./tiny/pkg/dist/pkg\n\n# download and unpack binaryen\nRUN wget -nv https://github.com/WebAssembly/binaryen/releases/download/version_${BINARYEN_VERSION}/binaryen-version_${BINARYEN_VERSION}-x86_64-linux.tar.gz \\\n  &amp;&amp; tar xf binaryen-version_${BINARYEN_VERSION}-x86_64-linux.tar.gz \\\n  &amp;&amp; ./binaryen-version_${BINARYEN_VERSION}/bin/wasm-opt --version\n\n# run wasm-opt against bundle.wasm\nRUN ./binaryen-version_${BINARYEN_VERSION}/bin/wasm-opt -Os ./tiny/pkg/dist/pkg/perseus_engine_bg.wasm -o ./tiny/pkg/dist/pkg/perseus_engine_bg.wasm \\\n  &amp;&amp; ls -lha ./tiny/pkg/dist/pkg\n\n# prepare deployment image\nFROM debian:stable-slim\n\nWORKDIR /app\n\nCOPY --from=build /app/tiny/pkg /app/\n\nENV HOST=0.0.0.0\n\nCMD [&quot;./server&quot;]\n</code></pre>\n</details>\n<details>\n<summary>Test example for deploying a specific branch from the Perseus repository</summary>\n<pre><code class=\"language-dockerfile\"># get the base image\nFROM rust:1.57-slim AS build\n\n# install build dependencies\nRUN apt update \\\n  &amp;&amp; apt install -y --no-install-recommends lsb-release apt-transport-https \\\n  build-essential curl\n\n# vars\nENV PERSEUS_BRANCH=main\n\n# prepare root project dir\nWORKDIR /app\n\n# download the target for wasm\nRUN rustup target add wasm32-unknown-unknown\n\n# install wasm-pack\nRUN cargo install wasm-pack\n\n# install bonnie\nRUN cargo install bonnie\n\n# retrieve the branch dir\nRUN curl https://codeload.github.com/framesurge/perseus/tar.gz/${PERSEUS_BRANCH} | tar -xz\n\n# go to branch dir\nWORKDIR /app/perseus-${PERSEUS_BRANCH}\n\n# install perseus-cli from branch\nRUN bonnie setup\n\n# clean app\nRUN bonnie dev example tiny clean\n\n# go to the branch dir\nWORKDIR /app/perseus-${PERSEUS_BRANCH}\n\n# single-threaded perseus CLI mode required for low memory environments\n#ENV PERSEUS_CLI_SEQUENTIAL=true\n\n# deploy app\nRUN bonnie dev example tiny deploy\n\n# move branch dir\nRUN mv /app/perseus-${PERSEUS_BRANCH} /app/perseus-branch\n\n# prepare deployment image\nFROM debian:stable-slim\n\nWORKDIR /app\n\nCOPY --from=build /app/perseus-branch/examples/tiny/pkg /app/\n\nENV HOST=0.0.0.0\n\nCMD [&quot;./server&quot;]\n</code></pre>\n</details>\n","current_version":"0.3.0-0.3.3","manifest":{"0.1.x":{"docs_rs":"0.1","git":"v0.1.4","state":"outdated"},"0.2.x":{"docs_rs":"0.2","git":"v0.2.3","state":"outdated"},"0.3.0-0.3.3":{"docs_rs":"0.3.3","git":"v0.3.3","state":"outdated"},"0.3.4":{"docs_rs":"0.3","git":"v0.3.6","state":"outdated"},"0.4.x":{"docs_rs":"0.4","git":"HEAD","state":"stable"}},"sidebar_content":"<h1>Introduction</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/intro\">Introduction</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/what-is-perseus\">What is Perseus?</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/hello-world\">Hello World!</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/second-app\">Your Second App</a></li>\n</ul>\n<hr />\n<h1>Reference</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/define-app\"><code>define_app!</code></a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/views\">Writing Views</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/debugging\">Debugging</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/templates/intro\">Templates and Routing</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/templates/metadata-modification\">Modifying the <code>&lt;head&gt;</code></a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/templates/setting-headers\">Modifying HTTP Headers</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/error-pages\">Error Pages</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/static-content\">Static Content</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/i18n/intro\">Internationalization</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/i18n/defining\">Defining Translations</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/i18n/using\">Using Translations</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/i18n/translations-managers\">Translations Managers</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/i18n/other-engines\">Other Translation Engines</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/strategies/intro\">Rendering Strategies</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/strategies/build-state\">Build State</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/strategies/build-paths\">Build Paths</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/strategies/request-state\">Request State</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/strategies/revalidation\">Revalidation</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/strategies/incremental\">Incremental Generation</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/strategies/amalgamation\">State Amalgamation</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/hydration\">Hydration</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/cli\">CLI</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/ejecting\">Ejecting</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/snooping\">Snooping</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/testing/intro\">Testing</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/testing/checkpoints\">Checkpoints</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/testing/fantoccini-basics\">Fantoccini Basics</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/testing/manual\">Manual Testing</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/styling\">Styling</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/server-communication\">Communicating with a Server</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/stores\">Stores</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/exporting\">Static Exporting</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/plugins/intro\">Plugins</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/plugins/functional\">Functional Actions</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/plugins/control\">Control Actions</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/plugins/using\">Using Plugins</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/plugins/tinker\">The <code>tinker</code> Action</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/plugins/writing\">Writing Plugins</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/plugins/security\">Security Considerations</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/plugins/publishing\">Publishing Plugins</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/deploying/intro\">Deploying</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/deploying/serverful\">Server Deployment</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/deploying/serverless\">Serverless Deployment</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/deploying/size\">Optimizing Code Size</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/deploying/relative-paths\">Relative Paths</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/deploying/docker\">Docker Deployment</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/updating\">Migrating from v0.2.x</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/pitfalls-and-bugs\">Common Pitfalls and Known Bugs</a></li>\n</ul>\n<hr />\n<h1>Advanced</h1>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/advanced/intro\">Under the Hood</a>\n<ul>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/advanced/arch\">Architecture</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/advanced/initial-loads\">Initial Loads</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/advanced/subsequent-loads\">Subsequent Loads</a></li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/advanced/routing\">Routing</a></li>\n</ul>\n</li>\n<li><a href=\"https://framesurge.sh/perseus/en-US/docs/0.3.0-0.3.3/advanced/define_app\"><code>define_app</code> in Detail</a></li>\n</ul>\n","status":"Outdated","title":"Docker Deployment"},"head":"<title>Docker Deployment | Perseus Docs</title><link rel=stylesheet href=.perseus/static/styles/markdown.css><link rel=stylesheet href=.perseus/static/styles/docs_links_markdown.css><link rel=stylesheet href=.perseus/static/prism.css>"}